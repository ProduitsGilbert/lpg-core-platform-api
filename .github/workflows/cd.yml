name: CD

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        # Build image locally on the self-hosted runner
        docker build -t lpg-core-platform-api:latest -t lpg-core-platform-api:${{ github.sha }} .

    - name: Deploy to production
      run: |
        # Navigate to deployment directory (adjust path as needed)
        cd /opt/lpg-core-platform-api || cd ${{ github.workspace }}

        # Copy environment file if needed
        cp .env.prod .env 2>/dev/null || echo "Using existing .env file"

        # Stop existing containers gracefully
        docker-compose -f docker-compose.prod.yml down --timeout 30

        # Start new containers
        docker-compose -f docker-compose.prod.yml up -d

        # Wait for health check
        echo "Waiting for application to be healthy..."
        for i in {1..30}; do
          if curl -f http://localhost:7003/healthz >/dev/null 2>&1; then
            echo "âœ… Application is healthy!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 5
        done

        # Clean up old images
        docker image prune -f
